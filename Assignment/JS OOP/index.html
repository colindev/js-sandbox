<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <title>JS OOP</title>
    <link href="style.css" rel="stylesheet">
  </head>
  <body>
    <div class="wrapper">
      <h1>::Lucky Draw::</h1>
      <h2 id="des"></h2>
      <div id="resultBox" class="resultBox"></div>
      <div id="ballsBox" class="ballsBox"></div>
      <button id="drawBtn" class="btn-draw">Draw</button>
      <button id="resetBtn" class="btn-reset">Reset</button>
    </div>

    <script>


      // get HTML DOM
      var _div = document.createElement("div") // 虛擬 DOM
      var ballsBox = document.getElementById("ballsBox");
      var resultBox = document.getElementById("resultBox");
      var drawBtn = document.getElementById("drawBtn");
      var resetBtn = document.getElementById("resetBtn");
      var des = document.getElementById("des");

      var ballsNum = 30;
      var drawNum = 5;
      var balls = [];
      var ballNodes = {};
      var drawBalls = [];
      var counter = drawBalls.length;
      var countSec = 0.5;

      // des
      des.innerHTML = drawNum + " in " + ballsNum;

      // resetBtn
      if (drawBalls.length == 0) {
        resetBtn.classList.add("close");
      }

      // build DOM
      function buildDom(html) {
        // 設定 innerHTML
        _div.innerHTML = html;
        // 移除結點並回傳
        return _div.removeChild(_div.firstChild);
      }

      // (新玩意) 立即涵式
      // create balls
      (function(num){
        for (var i = 1; i <= num; i++) {
          // set DOM id
          var id = "ball-"+i;

          // create DOM for each ball & i < 10 補 0
          ball = buildDom("<div id="+id+">"+(i<10?"0"+i:i)+"</div>");

          // add balls into ballsBox
          ballsBox.appendChild(ball);

          // add balls into {ballNode}
          ballNodes[id] = ball;

          // add balls into [balls]
          balls.push(id);
        }
      })(ballsNum)


      // button states change
      function drawState(btn, state, txt) {
        if (state == true) {
          btn.classList.remove("close");
          btn.textContent = txt;
          btn.disabled = false;
        } else {
          btn.classList.add("close");
          btn.textContent = txt;
          btn.disabled = true;
        }
      }

      // get darwNum of balls
      function drawBall() {
        // get a random number as index
        var ballIndex = Math.floor(Math.random() * balls.length);

        // remove drew balls from [balls]
        var id = balls.splice(ballIndex, 1)[0];

        // add drew balls into [drawBalls]
        drawBalls.push(id);

        console.log(id, ballIndex);

        // HTML DOM
        var drawBall = ballNodes[id];

        // add class to drew balls
        drawBall.classList.add("is-chose");

        // resultBox
        addResult(drawBalls.length - 1);

        if (drawBalls.length == drawNum) {
          // btn state
          drawState(drawBtn, false, "Done");
          drawState(resetBtn, true, "Reset");
        }
      }

      // add drewBalls into resultBox
      function addResult(drewNum) {

        // get ball number and build DOM
        var addBall = drawBalls[drewNum];
        addBall = addBall.substring(5);

        ball = buildDom("<div>" + (addBall<10?"0"+addBall:addBall) + "</div>");

        // add balls into ballsBox
        resultBox.appendChild(ball);
      }

      // auto draw
      function autoDraw() {
        var i = setInterval(function(){
          counter++;
          drawBall();
          if(counter === drawNum) {
              clearInterval(i);
          }
        }, countSec * 1000);
      }

      // reset balls
      function resetBalls() {
        // merge balls & drawBalls array
        balls = balls.concat(drawBalls);

        // sort array
        balls.sort(function(a, b){return a-b});

        // remove class
        for (var n in ballNodes) {
          ballNodes[n].classList.remove("is-chose");
        }

        // btn state
        drawState(drawBtn, true, "Draw");
        drawState(resetBtn, false, "Reset");

        // clean drawBalls array
        drawBalls = [];
        counter = 0;

        // clean resultBox
        resultBox.innerHTML = "";
      }

      drawBtn.addEventListener("click", autoDraw, false);
      resetBtn.addEventListener("click", resetBalls, false);

    </script>

  </body>
</html>
